(function(){var t=[].slice;this.SeapigRouter=function(){function e(e,s){var n,i,o,a,r,l,u,d,c,f,h,p,g,m,v,w;null==s&&(s={}),this.seapig_client=e,this.session_id=void 0,this.mountpoint=s.mountpoint||"/",this.default_state=s.default||{},this.debug=s.debug,this.expose=s.expose||[],this.cast=s.cast||function(t){return t},this.onsessionopen=s.onsessionopen,this.token=function(){var t,e,s,i;for(s=function(){var t,e;for(e=[],a=t=0;t<=11;a=++t)e.push(Math.floor(62*Math.random()));return e}(),i=[],t=0,e=s.length;t<e;t++)n=s[t],i.push(String.fromCharCode(48+n+(n>9?7:0)+(n>35?6:0)));return i}().join(""),this.debug&&console.log("ROUTER: Generated token: ",this.token),this.state=void 0,this.state_id=1,this.state_raw={session_id:void 0,state_id:0,state_parent:void 0,state_committed:!0},this.state_valid=!1,i=null,o=null,u=null,l={},s.expose_privates&&(this.private=l),d=this.seapig_client.master("SeapigRouter::Session::"+this.token+"::Data",{object:{token:this.token,session:this.session_id,states:{}}}),d.bump(),c=this.seapig_client.slave("SeapigRouter::Session::"+this.token+"::Saved"),c.onchange(function(t){return function(){var e,s,n,i;if(c.valid){for(n=_.keys(d.object.states),e=0,s=n.length;e<s;e++)i=n[e],parseInt(i)<c.object.max_state_id&&delete d.object.states[i];return null==t.session_id&&(t.session_id=c.object.session_id,null!=t.state&&null==t.state_raw.session_id&&(t.state.session_id=t.state_raw.session_id=t.session_id),t.debug&&console.log("ROUTER: Session opened",t.session_id),null!=t.onsessionopen&&t.onsessionopen(t.session_id)),t.debug&&console.log("ROUTER: Session saved up till:",c.object.max_state_id),t.state_valid?r(!1):void 0}}}(this)),document.onclick=function(t){return function(e){var s;return s=e.target.getAttribute("href")||"",t.debug&&console.log("ROUTER: A-element clicked, changing location to:",s),"?"!==s[0]||(t.navigate(s),!1)}}(this),window.onpopstate=function(t){return function(e){if(t.state_raw=JSON.parse(JSON.stringify(e.state)),null==t.state_raw.session_id&&(t.state_raw.session_id=t.session_id),t.state=t.cast(JSON.parse(JSON.stringify(t.state_raw))),t.debug&&console.log("ROUTER: History navigation triggered. Going to:",e.state),r(!1),null!=t.onchange)return t.onchange(t.state_raw,previous_state)}}(this),m=function(t){return function(t){return _.omit(t,function(t,e){return 0===e.indexOf("_")||"session_id"===e||"state_id"===e||"state_parent"===e||"state_committed"===e})}}(this),p=l.state_diff_generate=function(t){return function(t,e){var s,n,i;return n=function(t,e,n,o){var a;return a=typeof n==typeof o&&Array.isArray(n)===Array.isArray(o),(null==o||null!=n&&!a)&&(t.push(["-"+e,"-"]),n=void 0),Array.isArray(o)?s(t,e+"~",n||[],o):"object"==typeof o?i(t,e+".",n||{},o):null!=o&&n!==o?t.push([e,o]):void 0},i=function(t,e,s,i){var o,a,r,l;for(l=_.uniq(_.union(_.keys(s),_.keys(i))),a=0,r=l.length;a<r;a++)o=l[a],n(t,e+o,s[o],i[o]);return t},s=function(t,e,s,i){var o,r,l,u,d,c;for(r=0,a=u=0,d=s.length;u<d;a=++u)if(o=s[a],_.isEqual(o,i[r]))r++;else{for(l=r;!_.isEqual(o,i[l])&&l<i.length;)l++;if(l===i.length)"object"==typeof o?t.push(["-"+e+r+"~","-"]):t.push(["-"+e+"~",o]);else{for(;r<l;)n(t,e+r+"~",void 0,i[r++]);r++}}for(c=[];r<i.length;)c.push(n(t,e+"~",void 0,i[r++]));return c},i([],"",t,e)}}(this),h=l.state_diff_apply=function(t){return function(t,e){var s,n,i,o,r,l,u,d,c,f,h,p,g,m;for(l=0,u=e.length;l<u;l++){for(i=e[l],n=i[0],m=i[1],s="-"!==n[0],"-"===n[0]&&(n=n.slice(1)),h=t,p=n.split("."),a=c=0,d=p.length;c<d;a=++c)g=p[a],a<p.length-1&&("~"===g[g.length-1]?g.split("~")[1].length>0?(h[parseInt(g.split("~")[1])]||(h[parseInt(g.split("~")[1])]={}),h=h[parseInt(g.split("~")[1])]):(h[g.split("~")[0]]=[f={}],h=f):(null==h[g]&&(h[g]={}),h=h[g]));n=p[p.length-1],o="~"!==n[n.length-1],r=void 0,!o&&n.split("~")[1].length>0&&(r=parseInt(n.split("~")[1])),n=n.split("~")[0],s?o?h[n]=m:null!=r?(h[n]||(h[n]=[])).splice(r,0,m):(h[n]||(h[n]=[])).push(m):o?delete h[n]:null!=r?h[n].splice(r,1):h[n].splice(_.indexOf(h[n],m),1)}return t}}(this),w=function(t){return function(e,s){var n,i,o,a,r,l,u,d,c,f,h;if(f={session_id:null,state_id:null,buffer:[],exposed:[],change:[]},c=e.split(t.mountpoint),c.shift(),c=function(){var t,e,s,n;for(s=c.join(this.mountpoint).split("/"),n=[],t=0,e=s.length;t<e;t++)u=s[t],n.push(decodeURIComponent(u));return n}.call(t),h=c.shift(),"a"===h&&(f.session_id=c.shift(),"_"===f.session_id&&(f.session_id=void 0),f.state_id=c.shift()),null!=f.state_id){for(;c.length>0&&(o=c.shift(),"-"!==o);)n=_.find(t.expose,function(t){return t[1]}),n||next,f.exposed.push([n[0],c.shift()]);for(;c.length>0;)f.buffer.push([c.shift(),c.shift()])}else f.session_id=t.session_id,f.state_id=0,f.buffer=p(m(t.state_raw),m(t.default_state));if(s.length>1)for(d=s.split("?")[1].split("&"),a=0,r=d.length;a<r;a++)l=d[a],i=function(){var t,e,s,n;for(s=l.split("=",2),n=[],e=0,t=s.length;e<t;e++)u=s[e],n.push(decodeURIComponent(u));return n}(),f.change.push(i);return t.debug&&console.log("ROUTER: Parsed location",f),f}}(this),f=function(t){return function(e){var s,n;return t.debug&&console.log("ROUTER: Calculating url for state description:",e),n=t.mountpoint+"a/"+(e.session_id||"_")+"/"+e.state_id,e.exposed.length>0&&(n+="/"+function(){var t,n,i,o;for(i=_.flatten(e.exposed),o=[],t=0,n=i.length;t<n;t++)s=i[t],o.push(encodeURIComponent(s));return o}().join("/")),e.buffer.length>0&&(n+="/-/"+function(){var t,n,i,o;for(i=_.flatten(e.buffer),o=[],t=0,n=i.length;t<n;t++)s=i[t],o.push(encodeURIComponent(s));return o}().join("/")),t.debug&&console.log("ROUTER: Calculated url:",n),n}}(this),v=function(t){return function(e,s,n){var a,l,u,c,f;if(f=function(e){return t.debug&&console.log("ROUTER: Committing state:",t.state_raw),t.state_raw.state_committed=!0,d.object.states[t.state_raw.state_id]=m(t.state_raw),d.bump(),o&&clearTimeout(o),i=null,o=null,r(e)},a=Date.now()+s,l=t.state_raw.state_committed?t.state_raw:t.state_raw.state_parent,t.debug&&console.log("ROUTER: Changing state. Commit deferred by",s,"to be done at",a," State before mutation:",l),c=t.state_raw,u=JSON.parse(JSON.stringify(m(t.state_raw))),u=h(u,e.buffer),u=h(u,e.exposed),u=h(u,e.change),_.extend(u,_.pick(c,function(t,e){return 0===e.indexOf("_")})),p(m(l),m(u)).length>0?(u.state_committed=!1,c.state_committed?(u.session_id=t.session_id,u.state_id=t.state_id++,u.state_parent=c):(u.session_id=c.session_id,u.state_id=c.state_id,u.state_parent=c.state_parent)):(u.session_id=l.session_id,u.state_id=l.state_id,u.state_parent=l.state_parent,u.state_committed=l.state_committed),null!=t.filter&&t.filter(u,c),t.state_raw=u,t.state=t.cast(JSON.parse(JSON.stringify(t.state_raw))),t.state_valid=!0,t.state_raw.state_committed?(o&&clearTimeout(o),i=null,o=null):a<=Date.now()?f(n):(r(!1),(!i||a<i)&&(t.debug&&console.log("ROUTER: Deferring commit by:",s,"till",a),t.state_raw.state_committed=!1,o&&clearTimeout(o),i=a,o=setTimeout(function(){return f(n)},i-Date.now()))),null!=t.onchange)return t.onchange(t.state_raw,c)}}(this),g=function(t){return function(e){var s,n,i,o,a;for(o=e;o.state_parent&&(!o.session_id||o.session_id===t.session_id)&&(c.object.max_state_id||0)<o.state_id;)o=o.state_parent;return t.debug&&console.log("ROUTER: Last shareable state:",o),s=p(m(o),m(e)),i=function(){var t,s,i,o;for(i=p({},e),o=[],t=0,s=i.length;t<s;t++)a=i[t],(n=_.find(this.expose,function(t){return t[0]===a[0]}))&&o.push([n[1],a[1]]);return o}.call(t),s=function(){var t,e,n;for(n=[],t=0,e=s.length;t<e;t++)a=s[t],_.find(this.expose,function(t){return t[0]===a[0]})||n.push(a);return n}.call(t),{session_id:o.session_id,state_id:o.state_id,exposed:i,buffer:s,change:[]}}}(this),r=function(t){return function(e){var s;return s=f(g(t.state_raw)),t.debug&&console.log("ROUTER: Updating location:    state:",t.state_raw,"    url:",s),e?window.history.pushState(t.state_raw,null,s):window.history.replaceState(t.state_raw,null,s)}}(this),this.navigate=function(t,e){var s,n;return null==e&&(e={}),s=window.location.pathname,this.debug&&console.log("ROUTER: Navigating to:    pathname:",s,"    search:",t),n=w(s,t),this.debug&&console.log("ROUTER: New state description:",n),null!=u&&(u.unlink(),u=null),n.session_id===this.session_id||"0"===n.state_id?v(n,e.defer||0,!e.replace):(this.state_valid=!1,u=this.seapig_client.slave("SeapigRouter::Session::"+n.session_id+"::State::"+n.state_id),u.onchange(function(t){return function(){if(u.valid)return t.debug&&console.log("ROUTER: Received remote state",u.object),t.state_raw=JSON.parse(JSON.stringify(u.object)),t.state_raw.state_committed=!0,t.state_raw.session_id=n.session_id,t.state_raw.state_id=n.state_id,t.state_raw.state_parent=void 0,v(n,e.defer||0,!e.replace),u.unlink(),u=null}}(this)))},this.volatile=function(){var e,s,n,i;if(e=1<=arguments.length?t.call(arguments,0):[],1===e.length&&"object"==typeof e[0]){n=e[0];for(s in n)i=n[s],this.state["_"+s]=i;return _.extend(this.state_raw,_.pick(this.state,function(t,e){return 0===e.indexOf("_")})),window.history.replaceState(this.state_raw,null,window.location)}return _.object(function(){var t,n,i;for(i=[],t=0,n=e.length;t<n;t++)s=e[t],i.push([s,this.state["_"+s]]);return i}.call(this))}}return e}()}).call(this);
//# sourceMappingURL=seapig-router.min.js.map
